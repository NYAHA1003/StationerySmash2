using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;
using UnityEngine.EventSystems;
using Utill.Data;
using Utill.Tool;
using TMPro;
using Main.Event;
using DG.Tweening;

namespace Battle
{
    [System.Serializable]
    public class CostComponent : BattleComponent
    {
        //프로퍼티
        public int MaxCost { get; private set; } = 10; //최대 코스트
        public float AddCostSpeedValue { get; private set; } = 35f; //코스트 업그레이드시 증가하는 코스트 스피드값
        public int CurrentCost { get; private set; } = 0; //현재 코스트
        public int MaxGrade { get; private set; } = 5; //최대단계
        public int CurrentGrade { get; private set; } = 1; //현재 단계

        //변수
        public float _costSpeed = 200;
        public float _costDelay;
        private bool _isActiveButton; //버튼이 켜졌을 때

        //인스펙터 참조 변수
        [SerializeField]
        private TextMeshProUGUI _costText = null;
        [SerializeField]
        private Image _costImage = null;
        [SerializeField]
        private RectTransform _costUpButtonRect = null;
        [SerializeField]
        private Image _disableImage = null;
        [SerializeField]
        private TextAnimationComponent _textAnimationComponent;

        /// <summary>
        /// 초기화
        /// </summary>
        /// <param name="battleManager"></param>
        /// <param name="cost_CostText"></param>
        public void SetInitialization(ref System.Action updateAction, PencilCaseData pencilCasePlayerData)
        {
            updateAction += UpdateCost;
            SetCostSpeed(pencilCasePlayerData._costSpeed);
            EventManager.Instance.StartListening(EventsType.CostUp, OnUpgradeCostGrade);
        }

        /// <summary>
        /// 현재 코스트 증가
        /// </summary>
        /// <param name="addCost"></param>
        public void AddCost(int addCost)
        {
            CurrentCost += addCost;
            Vector2 animationPos = _costText.rectTransform.localPosition;
            animationPos.x += 250;
            _textAnimationComponent.SetText($"+{addCost}", animationPos, 0.5f, TextAnimationComponent.AnimationDirType.Right, TextAnimationComponent.AnimationType.BigToSmall);
            UpdateCostText();
        }

        /// <summary>
        /// 현재 코스트 감소
        /// </summary>
        /// <param name="subtractCost"></param>
        public void SubtractCost(int subtractCost)
        {
            CurrentCost -= subtractCost;
            Vector2 animationPos = _costText.rectTransform.localPosition;
            animationPos.x += 250;
            _textAnimationComponent.SetText($"-{subtractCost}", animationPos, 0.5f, TextAnimationComponent.AnimationDirType.Right, TextAnimationComponent.AnimationType.BigToSmall);
            UpdateCostText();
        }

        /// <summary>
        /// 현재 코스트 설정
        /// </summary>
        /// <param name="setCost"></param>
        public void SetCost(int setCost)
        {
            CurrentCost = setCost;
            UpdateCostText();
        }

        /// <summary>
        /// 코스트 증가 속도 설정
        /// </summary>
        /// <param name="speed"></param>
        public void SetCostSpeed(float speed)
        {
            _costSpeed = speed;
        }

        /// <summary>
        /// 코스트 증가 속도를 증가
        /// </summary>
        /// <param name="speed"></param>
        public void AddCostSpeed(float speed)
        {
            _costSpeed += speed;
        }

        /// <summary>
        /// 코스트 증가 속도를 곱해줌
        /// </summary>
        /// <param name="multiplespeed"></param>
        public void MultipleCostSpeed(float multiplespeed)
        {
            _costSpeed *= multiplespeed;
        }

        /// <summary>
        /// 코스트 업데이트
        /// </summary>
        private void UpdateCost()
        {
            if (CurrentCost >= MaxCost)
			{
                SetDisableImage(false);
                if(!_isActiveButton)
				{
                    _isActiveButton = true;
                    _costUpButtonRect.DOShakeAnchorPos(0.3f);
				}
                return;
			}
            else
            {
                _isActiveButton = false;
                SetDisableImage(true);
            }
            if (_costDelay > 0)
            {
                _costDelay -= _costSpeed * Time.deltaTime;
                _costImage.fillAmount = (100 - _costDelay) / 100;
                return;
            }
            AddCost(1);
            UpdateCostText();
            _costDelay = 100;
            _costImage.fillAmount = (100 - _costDelay) / 100;
        }

        /// <summary>
        /// 코스트 증가 버튼의 비활성화 이미지를 킬지 끌지
        /// </summary>
        private void SetDisableImage(bool setActive)
        {
            _disableImage.gameObject.SetActive(setActive);
        }

        /// <summary>
        /// 코스트 텍스트 업데이트
        /// </summary>
        private void UpdateCostText()
        {
            _costText.text = string.Format("{0} / {1}", CurrentCost.ToString(), MaxCost.ToString());
        }

        /// <summary>
        /// 코스트 단계를 업그레이드
        /// </summary>
        private void UpgradeCostGrade()
        {
            if (CurrentGrade >= MaxGrade)
            {
                return;
            }
            if (CurrentCost < MaxCost)
            {
                return;
            }

            SubtractCost(MaxCost);
            MaxCost += CurrentGrade * 5; //최대 코스트 증가
            CurrentGrade++;
            AddCostSpeed(AddCostSpeedValue); //업그레이드시 빨라지는 속도값
            UpdateCostText();
        }

        /// <summary>
        /// 클릭하면 코스트 단계 증가
        /// </summary>
        private void OnUpgradeCostGrade()
        {
            UpgradeCostGrade();
        }

    }
}
